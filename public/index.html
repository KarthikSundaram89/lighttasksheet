<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LightTaskSheet -- XLSX Export & Shortcuts</title>
<style>
:root{
  --bg:#f6fbff; --card:#fff; --muted:#6b7280; --accent:#2563eb; --border:#e6eef7;
  --radius:12px; --shadow:0 8px 24px rgba(16,24,40,0.06); --chip-size:12px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:14px; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  background:linear-gradient(180deg,#fbfdff,var(--bg)); color:#0f172a;
}

/* header */
.app-header{ display:flex; gap:12px; align-items:center; padding:12px 14px; border-radius:var(--radius); background:var(--card); border:1px solid var(--border); box-shadow:var(--shadow); }
.app-title{ margin:0; font-weight:700; font-size:1.05rem; }
.spacer{ flex:1; }
.username-tag{ font-size:14px; color:var(--muted); padding:4px 8px; background:#eef6ff; border-radius:6px; display:none; }

/* controls */
.controls{ margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.btn{ padding:8px 12px; border-radius:8px; border:0; cursor:pointer; font-weight:600; }
.btn.primary{ background:var(--accent); color:white; }
.btn.ghost{ background:white; color:var(--muted); border:1px solid #dfe9f5; }

/* sheet */
.sheet-card{ margin-top:12px; border-radius:12px; background:var(--card); border:1px solid var(--border); box-shadow:var(--shadow); padding:0; overflow:auto; max-height:72vh; position:relative; }
table.sheet{ width:100%; border-collapse:collapse; table-layout:fixed; min-width:640px; }
table.sheet thead th{ position:sticky; top:0; z-index:3; padding:8px 12px; background:#f5f9ff; color:var(--muted); font-weight:700; border-bottom:1px solid #eef7fc; }
table.sheet td{ padding:10px 12px; border-bottom:1px solid #f4f9fd; vertical-align:top; word-break:break-word; background:white; }

/* header elements */
.col-header{ display:flex; gap:8px; align-items:center; }
.col-title{ flex:1; cursor:grab; padding:4px 6px; border-radius:6px; }
.color-chip{ width:var(--chip-size); height:var(--chip-size); border-radius:4px; border:1px solid rgba(0,0,0,0.06); cursor:pointer; }
.type-select{ font-size:12px; padding:4px; border-radius:6px; }

/* sub-row visuals */
.sub-row td{ padding-left:28px !important; background:#fbfcff; }
.sub-prefix{ font-weight:600; margin-right:6px; color:#555; }

/* tags */
.tag{ display:inline-block; padding:2px 6px; border-radius:999px; font-size:12px; margin:2px 4px 2px 0; background:#eef7ff; color:#0452a5; border:1px solid rgba(4,82,165,0.06); }

/* help modal */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:9999; }
.modal{ background:white; padding:16px; border-radius:10px; width:94%; max-width:560px; box-shadow:0 10px 30px rgba(2,6,23,0.2); }
.modal h3{ margin-top:0; }
.kb{ background:#f6f9ff; padding:8px 10px; border-radius:6px; display:inline-block; font-weight:700; color:#08306a; }

/* toast */
.toast{ position:fixed; top:22px; right:22px; background:#042A65; color:white; padding:10px 14px; border-radius:10px; display:none; z-index:10000; }

/* help icon */
.help-btn{ background:transparent; border:0; font-weight:700; font-size:18px; color:var(--muted); cursor:pointer; }

/* responsive */
@media (max-width:720px){
  .app-header{ flex-direction:column; align-items:stretch; gap:8px; }
}
</style>
</head>
<body>

<header class="app-header">
  <h1 class="app-title">LightTaskSheet</h1>
  <div class="spacer"></div>

  <button id="helpBtn" class="help-btn" title="Help / Shortcuts">?</button>
  <span id="userTag" class="username-tag"></span>

  <div style="display:flex;gap:8px;align-items:center">
    <input id="username" placeholder="username" style="padding:8px;border-radius:6px;border:1px solid #e9f1fb" />
    <input id="password" placeholder="password" type="password" style="padding:8px;border-radius:6px;border:1px solid #e9f1fb" />
    <button id="loginBtn" class="btn primary">Login</button>
    <button id="registerBtn" class="btn ghost">Register</button>
    <button id="logoutBtn" class="btn ghost" style="display:none">Logout</button>
  </div>
</header>

<div class="controls">
  <button id="addRowBtn" class="btn ghost">+ Add row</button>
  <button id="addColBtn" class="btn ghost">+ Add column</button>
  <button id="delColBtn" class="btn ghost">Delete last column</button>
  <button id="saveBtn" class="btn primary">Save</button>
  <button id="collapseAllBtn" class="btn ghost">Collapse All</button>
  <button id="expandAllBtn" class="btn ghost">Expand All</button>

  <button id="exportBtn" class="btn ghost">Export JSON</button>
  <button id="exportXlsBtn" class="btn ghost">Export Excel (.xlsx)</button>
  <input id="importFile" type="file" accept="application/json" style="margin-left:8px" />
  <div style="margin-left:auto;color:#6b7280">Shortcuts: âŒ˜/Ctrl+S Save â€¢ âŒ˜+E Export â€¢ âŒ˜+â‡§+E Excel</div>
</div>

<main class="sheet-card">
  <table id="sheetTable" class="sheet" aria-label="task sheet"></table>
</main>

<div id="toast" class="toast">Saved âœ“</div>

<!-- Help modal -->
<div id="modal" class="modal-backdrop" role="dialog" aria-hidden="true">
  <div class="modal" role="document" aria-labelledby="helpTitle">
    <h3 id="helpTitle">Help & Keyboard Shortcuts</h3>
    <p>Useful keyboard shortcuts and quick tips.</p>
    <ul>
      <li><span class="kb">Ctrl / Cmd + S</span> -- Save</li>
      <li><span class="kb">Ctrl / Cmd + E</span> -- Export JSON</li>
      <li><span class="kb">Ctrl / Cmd + Shift + E</span> -- Export Excel (.xlsx)</li>
      <li><span class="kb">Ctrl / Cmd + N</span> -- New row</li>
      <li><span class="kb">Ctrl / Cmd + Shift + N</span> -- New column</li>
      <li><span class="kb">Ctrl / Cmd + Shift + C</span> -- Collapse all</li>
      <li><span class="kb">Ctrl / Cmd + Shift + O</span> -- Expand all</li>
    </ul>
    <p>Drag column headers to reorder. Click a column color chip to cycle colors. Change column type via the dropdown.</p>
    <div style="text-align:right; margin-top:8px;">
      <button id="closeModal" class="btn primary">Close</button>
    </div>
  </div>
</div>

<script>
/* ============================================================
   Minimal XLSX (real .xlsx) builder + full UI
   - XLSX zipped package using STORE method (no compression)
   - Timestamps exported as TEXT (your choice)
   ============================================================ */

/* ---------- Config & simple utilities ---------- */
const API = '/api';
const TOKEN_KEY = 'lts_token', USER_KEY = 'lts_user';
const PALETTE = ['#ffd8a8','#c6f6d5','#dbeafe','#fde68a','#fbcfe8','#e6e6fa','#d1fae5','#fce7f3'];

let token = localStorage.getItem(TOKEN_KEY) || null;
let username = localStorage.getItem(USER_KEY) || null;

/* initial sheet */
let sheet = {
  columns: [ {name:'Timestamp',type:'date',color:PALETTE[2]}, {name:'Task',type:'text',color:PALETTE[0]}, {name:'Notes',type:'text',color:PALETTE[1]} ],
  rows: []
};

function nowISO(){ return new Date().toISOString(); }
function fmtLocal(iso){ if(!iso) return ''; try { return new Date(iso).toLocaleString(); } catch(e){ return iso; } }
function uid(){ return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8); }
function showToast(msg='Saved âœ“'){ const t=document.getElementById('toast'); t.textContent = msg; t.style.display='block'; clearTimeout(t._t); t._t = setTimeout(()=> t.style.display='none',1200); }

/* ---------- Auth UI ---------- */
const usernameInput = document.getElementById('username'), passwordInput = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn'), registerBtn = document.getElementById('registerBtn'), logoutBtn = document.getElementById('logoutBtn');
const userTag = document.getElementById('userTag'), helpBtn = document.getElementById('helpBtn'), modal = document.getElementById('modal'), closeModal = document.getElementById('closeModal');

function updateAuthUI(){
  if(username){
    usernameInput.style.display='none'; passwordInput.style.display='none';
    loginBtn.style.display='none'; registerBtn.style.display='none'; logoutBtn.style.display='';
    userTag.style.display='inline-block'; userTag.textContent = username;
  } else {
    usernameInput.style.display=''; passwordInput.style.display='';
    loginBtn.style.display=''; registerBtn.style.display=''; logoutBtn.style.display='none';
    userTag.style.display='none';
  }
}
updateAuthUI();

loginBtn.addEventListener('click', async ()=>{
  const u = usernameInput.value.trim(), p = passwordInput.value;
  if(!u||!p) return alert('username & password required');
  const r = await fetch(API + '/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u,password:p}) });
  const j = await r.json(); if(!r.ok) return alert('Login failed: ' + (j.error || r.statusText));
  token = j.token; username = j.username; localStorage.setItem(TOKEN_KEY, token); localStorage.setItem(USER_KEY, username);
  updateAuthUI(); await loadSheet();
});
registerBtn.addEventListener('click', async ()=>{
  const u = usernameInput.value.trim(), p = passwordInput.value;
  if(!u||!p) return alert('username & password required');
  const r = await fetch(API + '/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u,password:p}) });
  if(!r.ok) return alert('Register failed'); alert('User created -- please login.');
});
logoutBtn.addEventListener('click', ()=> doLogout());
function doLogout(){ token=null; username=null; localStorage.removeItem(TOKEN_KEY); localStorage.removeItem(USER_KEY); updateAuthUI(); sheet.rows = []; renderTable(); }

/* modal */
helpBtn.addEventListener('click', ()=> { modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); });
closeModal.addEventListener('click', ()=> { modal.style.display='none'; modal.setAttribute('aria-hidden','true'); });
modal.addEventListener('click', (e)=> { if(e.target === modal) { modal.style.display='none'; modal.setAttribute('aria-hidden','true'); } });

/* ---------- Migration for old format ---------- */
function migrateColumnsIfNeeded(){
  if(!sheet.columns) sheet.columns = [];
  if(sheet.columns.length && typeof sheet.columns[0] === 'string'){
    const old = sheet.columns.slice();
    sheet.columns = old.map((name,i)=>({ name: name || ('Column '+(i+1)), type:'text', color: PALETTE[i%PALETTE.length] }));
  } else {
    sheet.columns = sheet.columns.map((c,i)=> {
      if(typeof c === 'string') return { name: c, type: 'text', color: PALETTE[i%PALETTE.length] };
      return { name: c.name || ('Column '+(i+1)), type: c.type || 'text', color: c.color || PALETTE[i%PALETTE.length] };
    });
  }
}

/* ---------- Load / Save ---------- */
async function apiFetch(path, opts={}) {
  opts.headers = opts.headers || {};
  if(!opts.headers['Content-Type']) opts.headers['Content-Type'] = 'application/json';
  if(token) opts.headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch(API + path, opts);
  if(res.status === 401) { alert('Auth error -- please login again'); doLogout(); }
  return res;
}

async function loadSheet(){
  if(!username) return alert('login first');
  const res = await apiFetch('/sheet/' + encodeURIComponent(username));
  const j = await res.json();
  if(j.sheet){ sheet = j.sheet; migrateColumnsIfNeeded(); renderTable(); }
}
async function saveSheet(){
  if(!username) return alert('login first');
  await apiFetch('/sheet/' + encodeURIComponent(username), { method:'POST', body: JSON.stringify({ sheet }) });
  showToast('Saved âœ“');
}

/* ---------- Column helpers ---------- */
function getNextColumnName(){
  let max=0;
  for(const c of sheet.columns){
    const m = (c.name||'').match(/^Column\s+(\d+)$/i);
    if(m) max = Math.max(max, parseInt(m[1],10));
  }
  return 'Column '+(max+1);
}
function pickColorForNewColumn(){
  const used = new Set(sheet.columns.map(c=>c.color));
  for(const p of PALETTE) if(!used.has(p)) return p;
  return PALETTE[Math.floor(Math.random()*PALETTE.length)];
}

/* ---------- Table rendering ---------- */
const sheetTable = document.getElementById('sheetTable');

function renderTable(){
  sheetTable.innerHTML = '';
  migrateColumnsIfNeeded();

  const thead = document.createElement('thead');
  const trh = document.createElement('tr');

  sheet.columns.forEach((col, colIndex)=>{
    const th = document.createElement('th'); th.dataset.colIndex = colIndex;
    const header = document.createElement('div'); header.className = 'col-header';

    const title = document.createElement('div'); title.className = 'col-title'; title.textContent = col.name || ''; title.draggable = true;
    header.appendChild(title);

    const chip = document.createElement('div'); chip.className = 'color-chip'; chip.style.background = col.color || '#eee';
    chip.title = 'Click to change color'; chip.addEventListener('click', ()=> { const idx = PALETTE.indexOf(col.color); col.color = PALETTE[(idx+1+PALETTE.length)%PALETTE.length]; renderTable(); });
    header.appendChild(chip);

    const select = document.createElement('select'); select.className = 'type-select';
    ['text','date','number','tags'].forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; if(col.type === t) o.selected = true; select.appendChild(o); });
    select.addEventListener('change', ()=> { col.type = select.value; renderTable(); });
    header.appendChild(select);

    const actions = document.createElement('div'); actions.style.marginLeft = '6px';
    const del = document.createElement('button'); del.className = 'btn ghost'; del.style.padding = '6px'; del.textContent = 'ðŸ—‘'; del.title = 'Delete column';
    del.addEventListener('click', ()=> deleteColumn(colIndex));
    actions.appendChild(del);
    header.appendChild(actions);

    th.appendChild(header);

    // drag handlers
    title.addEventListener('dragstart', (e)=> { e.dataTransfer.setData('text/plain', String(colIndex)); e.dataTransfer.effectAllowed = 'move'; th.classList.add('dragging'); });
    title.addEventListener('dragend', ()=> { document.querySelectorAll('th').forEach(x=>x.classList.remove('dragging','drag-over')); });
    th.addEventListener('dragover', (e)=> { e.preventDefault(); th.classList.add('drag-over'); });
    th.addEventListener('dragleave', ()=> th.classList.remove('drag-over'));
    th.addEventListener('drop', (e)=> { e.preventDefault(); const from = parseInt(e.dataTransfer.getData('text/plain'),10); const to = parseInt(th.dataset.colIndex,10); if(!isNaN(from) && !isNaN(to) && from !== to) reorderColumns(from,to); });

    trh.appendChild(th);
  });

  const thx = document.createElement('th'); thx.textContent = ''; trh.appendChild(thx);
  thead.appendChild(trh);
  sheetTable.appendChild(thead);

  const tbody = document.createElement('tbody');
  const collapsed = {}; sheet.rows.forEach(r => { if(!r._sub && r._id) collapsed[r._id] = !!r._collapsed; });

  for(let i=0;i<sheet.rows.length;i++){
    const row = sheet.rows[i];
    if(row._sub && row._parent && collapsed[row._parent]) continue;

    const tr = document.createElement('tr'); if(row._sub) tr.classList.add('sub-row');

    for(let ci=0; ci<sheet.columns.length; ci++){
      const col = sheet.columns[ci];
      const td = document.createElement('td');

      if(ci === 0){
        td.textContent = row[0] ? fmtLocal(row[0]) : '';
      } else {
        if(col.type === 'date'){
          const inp = document.createElement('input'); inp.type = 'datetime-local';
          if(row[ci]){ try { const d = new Date(row[ci]); const pad=(n)=>String(n).padStart(2,'0'); inp.value = d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes()); } catch(e){} }
          inp.addEventListener('change', ()=> row[ci] = inp.value ? new Date(inp.value).toISOString() : '');
          td.appendChild(inp);
        } else if(col.type === 'number'){
          const inp = document.createElement('input'); inp.type = 'number'; inp.value = row[ci] !== undefined ? row[ci] : '';
          inp.addEventListener('input', ()=> { const n = parseFloat(inp.value); row[ci] = isNaN(n) ? '' : n; });
          td.appendChild(inp);
        } else if(col.type === 'tags'){
          const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.flexWrap='wrap'; wrap.style.gap='4px';
          const tags = Array.isArray(row[ci]) ? row[ci] : (row[ci] ? String(row[ci]).split(',').map(s=>s.trim()).filter(Boolean) : []);
          tags.forEach(t => { const el = document.createElement('span'); el.className='tag'; el.textContent = t; wrap.appendChild(el); });
          const inp = document.createElement('input'); inp.type='text'; inp.placeholder='tag1,tag2'; inp.style.marginTop='6px'; inp.style.width='100%';
          inp.addEventListener('change', ()=> { row[ci] = String(inp.value).split(',').map(s=>s.trim()).filter(Boolean); renderTable(); });
          td.appendChild(wrap); td.appendChild(inp);
        } else {
          const span = document.createElement('div'); span.contentEditable = true; span.style.minHeight='24px';
          if(row._sub && ci === 1){
            const prefix = document.createElement('span'); prefix.className='sub-prefix'; prefix.textContent = 'â†³';
            span.appendChild(prefix);
            const content = document.createElement('span'); content.textContent = row[ci] || '';
            span.appendChild(content);
            span.addEventListener('input', ()=> { const text = span.innerText.replace('â†³','').trim(); row[ci] = text; });
          } else {
            span.innerText = row[ci] || ''; span.addEventListener('input', ()=> row[ci] = span.innerText);
          }
          td.appendChild(span);
        }
      }
      tr.appendChild(td);
    }

    const act = document.createElement('td'); act.style.display='flex'; act.style.gap='8px'; act.style.alignItems='center';
    if(!row._sub){
      const collapseBtn = document.createElement('button'); collapseBtn.className='btn ghost'; collapseBtn.style.padding='6px'; collapseBtn.textContent = row._collapsed ? 'â–¸' : 'â–¾';
      collapseBtn.addEventListener('click', ()=> { row._collapsed = !row._collapsed; renderTable(); });
      act.appendChild(collapseBtn);
      const addSub = document.createElement('button'); addSub.className='btn ghost'; addSub.style.padding='6px'; addSub.textContent='+ sub-row';
      addSub.addEventListener('click', ()=> addSubRow(i));
      act.appendChild(addSub);
    } else {
      const small = document.createElement('div'); small.textContent = 'sub'; small.style.color = '#6b7280'; act.appendChild(small);
    }
    tr.appendChild(act);
    tbody.appendChild(tr);
  }

  sheetTable.appendChild(tbody);
}

/* ---------- Column & row operations ---------- */
function addColumn(){
  const suggested = getNextColumnName();
  const name = prompt('Column name:', suggested);
  if(name === null) return;
  const col = { name: name.trim() || suggested, type: 'text', color: pickColorForNewColumn() };
  sheet.columns.push(col);
  sheet.rows.forEach(r => r.push(''));
  renderTable();
}
function deleteColumn(index){
  if(sheet.columns.length <= 1) return alert('Cannot delete all columns');
  if(!confirm('Delete column "'+sheet.columns[index].name+'"? This will remove data from every row.')) return;
  sheet.columns.splice(index,1);
  sheet.rows.forEach(r => r.splice(index,1));
  renderTable();
}
function reorderColumns(from,to){
  const col = sheet.columns.splice(from,1)[0]; sheet.columns.splice(to,0,col);
  sheet.rows.forEach(r => { const cell = r.splice(from,1)[0]; r.splice(to,0,cell); });
  renderTable();
}
function addRow(){ const r=[ nowISO(), '', '' ]; r._id=uid(); r._collapsed=false; r._sub=false; sheet.rows.push(r); renderTable(); }
function addSubRow(parentIndex){ const parent = sheet.rows[parentIndex]; if(!parent) return; const s=[ nowISO(), '', '' ]; s._id=uid(); s._sub=true; s._parent=parent._id; sheet.rows.splice(parentIndex+1,0,s); renderTable(); }
function collapseAll(){ sheet.rows.forEach(r => { if(!r._sub) r._collapsed = true; }); renderTable(); }
function expandAll(){ sheet.rows.forEach(r => { if(!r._sub) r._collapsed = false; }); renderTable(); }
function getNextColumnName(){ let max = 0; for(const c of sheet.columns){ const m = (c.name||'').match(/^Column\s+(\d+)$/i); if(m) max = Math.max(max, parseInt(m[1],10)); } return 'Column '+(max+1); }
function pickColorForNewColumn(){ const used = new Set(sheet.columns.map(c=>c.color)); for(const p of PALETTE) if(!used.has(p)) return p; return PALETTE[Math.floor(Math.random()*PALETTE.length)]; }

/* ---------- Export Excel: build real .xlsx ZIP (STORE method) ---------- */
/*
  Approach:
  - Build XML files for minimal workbook:
    [Content_Types].xml
    _rels/.rels
    docProps/core.xml
    docProps/app.xml
    xl/workbook.xml
    xl/worksheets/sheet1.xml
    xl/styles.xml (minimal)
  - Create ZIP with STORE compression (no compression) by writing proper local file headers + central directory.
  - CRC32 calculation included.
  - Trigger download with blob.
  Notes:
  - Timestamps are exported as TEXT (user choice).
*/

function exportXlsx() {
  // build XMLs (strings)
  const files = {
    '[Content_Types].xml': contentTypesXml(),
    '_rels/.rels': relsRelsXml(),
    'docProps/core.xml': docPropsCoreXml(),
    'docProps/app.xml': docPropsAppXml(),
    'xl/workbook.xml': xlWorkbookXml(),
    'xl/worksheets/sheet1.xml': xlWorksheetXml(),
    'xl/styles.xml': xlStylesXml()
  };

  const zipBlob = zipFiles(files); // returns a Blob
  const a = document.createElement('a');
  a.href = URL.createObjectURL(zipBlob);
  a.download = (username || 'sheet') + '.xlsx';
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 60000);
}

/* --------- XML generators --------- */

function escapeXml(s){ if(s===undefined||s===null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function contentTypesXml(){
  return `<?xml version="1.0" encoding="UTF-8"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
  <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
  <Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/>
  <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>
  <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>
</Types>`;
}

function relsRelsXml(){
  return `<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
  <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>
  <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>
</Relationships>`;
}

function docPropsCoreXml(){
  const now = new Date().toISOString();
  return `<?xml version="1.0" encoding="UTF-8"?>
<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <dc:creator>${escapeXml(username||'')}</dc:creator>
  <cp:lastModifiedBy>${escapeXml(username||'')}</cp:lastModifiedBy>
  <dcterms:created xsi:type="dcterms:W3CDTF">${now}</dcterms:created>
  <dcterms:modified xsi:type="dcterms:W3CDTF">${now}</dcterms:modified>
</cp:coreProperties>`;
}

function docPropsAppXml(){
  return `<?xml version="1.0" encoding="UTF-8"?>
<Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties" xmlns:vt="http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes">
  <Application>LightTaskSheet</Application>
  <DocSecurity>0</DocSecurity>
  <ScaleCrop>false</ScaleCrop>
  <HeadingPairs>
    <vt:vector size="2" baseType="variant"><vt:variant><vt:lpstr>Worksheets</vt:lpstr></vt:variant><vt:variant><vt:i4>1</vt:i4></vt:variant></vt:vector>
  </HeadingPairs>
  <TitlesOfParts><vt:vector size="1" baseType="lpstr"><vt:lpstr>Sheet1</vt:lpstr></vt:vector></TitlesOfParts>
  <Company></Company>
  <LinksUpToDate>false</LinksUpToDate>
  <SharedDoc>false</SharedDoc>
  <HyperlinksChanged>false</HyperlinksChanged>
  <AppVersion>1.0</AppVersion>
</Properties>`;
}

function xlWorkbookXml(){
  return `<?xml version="1.0" encoding="UTF-8"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <sheets>
    <sheet name="Sheet1" sheetId="1" r:id="rId1"/>
  </sheets>
</workbook>`;
}

function xlStylesXml(){
  // minimal styles
  return `<?xml version="1.0" encoding="UTF-8"?>
<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
  <fonts count="1"><font><sz val="11"/><color rgb="FF000000"/><name val="Calibri"/></font></fonts>
  <fills count="1"><fill><patternFill patternType="none"/></fill></fills>
  <borders count="1"><border/></borders>
  <cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>
  <cellXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0"/></cellXfs>
</styleSheet>`;
}

function xlWorksheetXml(){
  // Build rows: first header row, then data rows; timestamps are text
  let xml = `<?xml version="1.0" encoding="UTF-8"?>
<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
  <sheetData>\n`;

  // header
  xml += '    <row r="1">\n';
  for(let c=0;c<sheet.columns.length;c++){
    const col = sheet.columns[c];
    xml += `      <c r="${colLetter(c)}1" t="inlineStr"><is><t>${escapeXml(col.name||'')}</t></is></c>\n`;
  }
  xml += '    </row>\n';

  // data rows (1-based row numbering; header at 1)
  let rr = 2;
  for(const row of sheet.rows){
    // each row
    xml += `    <row r="${rr}">\n`;
    for(let c=0;c<sheet.columns.length;c++){
      let v = row[c];
      if(row._sub && c === 1){
        v = (v ? 'â†³ ' + v : 'â†³');
      }
      // store everything as inline string to avoid number/date quirks (you requested TEXT timestamps)
      xml += `      <c r="${colLetter(c)}${rr}" t="inlineStr"><is><t>${escapeXml(v===undefined||v===null?'':String(v))}</t></is></c>\n`;
    }
    xml += '    </row>\n';
    rr++;
  }

  xml += '  </sheetData>\n</worksheet>';
  return xml;
}

function colLetter(idx){
  // 0 -> A, 1 -> B ... 25 -> Z, 26 -> AA
  let s = '';
  let n = idx + 1;
  while(n > 0){
    const rem = (n - 1) % 26;
    s = String.fromCharCode(65 + rem) + s;
    n = Math.floor((n - 1) / 26);
  }
  return s;
}

/* ---------- ZIP (STORE method) implementation ---------- */
/* Minimal ZIP writer that creates a valid zip with uncompressed files.
   It writes local file headers, central directory, and end record.
   CRC32 is computed for each file.
*/

function zipFiles(filesMap){
  // filesMap: { "path": "content string", ... }
  const encoder = new TextEncoder();
  const entries = [];
  let offset = 0;
  const parts = [];

  // helper to write little-endian
  function le32(n){ return [n & 0xff, (n>>8)&0xff, (n>>16)&0xff, (n>>24)&0xff]; }
  function le16(n){ return [n & 0xff, (n>>8)&0xff]; }

  // CRC32 table
  const crcTable = (function(){
    const table = new Uint32Array(256);
    for(let i=0;i<256;i++){
      let c = i;
      for(let k=0;k<8;k++){
        if(c & 1) c = 0xedb88320 ^ (c >>> 1); else c = c >>> 1;
      }
      table[i] = c >>> 0;
    }
    return table;
  })();

  function crc32(buf){
    let crc = 0 ^ (-1);
    for(let i=0;i<buf.length;i++){
      crc = (crc >>> 8) ^ crcTable[(crc ^ buf[i]) & 0xff];
    }
    return (crc ^ (-1)) >>> 0;
  }

  // Build local file header + data for each file
  for(const name of Object.keys(filesMap)){
    const contentStr = filesMap[name];
    // ensure forward slashes for paths
    const filename = name.replace(/\\/g,'/');
    const data = encoder.encode(contentStr);
    const crc = crc32(data);
    const compressedSize = data.length;
    const uncompressedSize = data.length;

    // local file header
    // signature 0x04034b50
    const localHeader = new Uint8Array(30 + filename.length);
    let p=0;
    // signature
    localHeader.set([0x50,0x4b,0x03,0x04], p); p+=4;
    localHeader.set(le16(20), p); p+=2; // version needed to extract
    localHeader.set(le16(0), p); p+=2; // general purpose bit flag
    localHeader.set(le16(0), p); p+=2; // compression method 0 = store
    localHeader.set(le16(0), p); p+=2; // mod time
    localHeader.set(le16(0), p); p+=2; // mod date
    localHeader.set(le32(crc), p); p+=4; // crc32
    localHeader.set(le32(compressedSize), p); p+=4;
    localHeader.set(le32(uncompressedSize), p); p+=4;
    localHeader.set(le16(filename.length), p); p+=2;
    localHeader.set(le16(0), p); p+=2; // extra len
    // filename bytes
    localHeader.set(encoder.encode(filename), p); p+=filename.length;

    parts.push(localHeader);
    parts.push(data);

    entries.push({
      name: filename,
      crc,
      compressedSize,
      uncompressedSize,
      localHeaderOffset: offset
    });

    offset += localHeader.length + data.length;
  }

  // build central directory
  const centralParts = [];
  let cdSize = 0;
  for(const e of entries){
    const filenameBytes = new TextEncoder().encode(e.name);
    const cdfh = new Uint8Array(46 + filenameBytes.length);
    let p=0;
    // central dir file header signature 0x02014b50
    cdfh.set([0x50,0x4b,0x01,0x02], p); p+=4;
    cdfh.set(le16(0x033f), p); p+=2; // version made by (just a number)
    cdfh.set(le16(20), p); p+=2; // version needed
    cdfh.set(le16(0), p); p+=2; // flags
    cdfh.set(le16(0), p); p+=2; // method
    cdfh.set(le16(0), p); p+=2; // mt
    cdfh.set(le16(0), p); p+=2; // md
    cdfh.set(le32(e.crc), p); p+=4;
    cdfh.set(le32(e.compressedSize), p); p+=4;
    cdfh.set(le32(e.uncompressedSize), p); p+=4;
    cdfh.set(le16(filenameBytes.length), p); p+=2;
    cdfh.set(le16(0), p); p+=2; // extra
    cdfh.set(le16(0), p); p+=2; // file comment length
    cdfh.set(le16(0), p); p+=2; // disk number start
    cdfh.set(le16(0), p); p+=2; // internal attrs
    cdfh.set(le32(0), p); p+=4; // external attrs
    cdfh.set(le32(e.localHeaderOffset), p); p+=4;
    cdfh.set(filenameBytes, p); p+=filenameBytes.length;
    centralParts.push(cdfh);
    cdSize += cdfh.length;
  }

  // end of central dir
  const cdOffset = offset;
  const eocd = new Uint8Array(22);
  let q=0;
  eocd.set([0x50,0x4b,0x05,0x06], q); q+=4; // signature
  eocd.set(le16(0), q); q+=2; // disk number
  eocd.set(le16(0), q); q+=2; // cd start disk
  eocd.set(le16(entries.length), q); q+=2; // entries on this disk
  eocd.set(le16(entries.length), q); q+=2; // total entries
  eocd.set(le32(cdSize), q); q+=4; // central dir size
  eocd.set(le32(cdOffset), q); q+=4; // central dir offset
  eocd.set(le16(0), q); q+=2; // comment length

  // combine all parts into one blob
  const all = [...parts, ...centralParts, eocd];
  return new Blob(all, { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
}

/* ---------- Wire export button ---------- */
document.getElementById('exportXlsBtn').addEventListener('click', exportXlsx);

/* ---------- JSON export/import ---------- */
document.getElementById('exportBtn').addEventListener('click', ()=> {
  const blob = new Blob([JSON.stringify(sheet,null,2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (username||'sheet') + '.json'; a.click();
});
document.getElementById('importFile').addEventListener('change', (ev)=> {
  const f = ev.target.files[0]; if(!f) return;
  const fr = new FileReader();
  fr.onload = (e) => {
    try {
      const obj = JSON.parse(e.target.result);
      if(!obj.columns || !obj.rows) throw new Error('invalid format');
      sheet = obj; migrateColumnsIfNeeded(); renderTable();
    } catch(err){ alert('Import error: ' + err.message); }
  };
  fr.readAsText(f);
});

/* ---------- Keyboard shortcuts ---------- */
window.addEventListener('keydown', (e)=>{
  const meta = (navigator.platform.indexOf('Mac')>=0 ? e.metaKey : e.ctrlKey);
  if(meta && e.key.toLowerCase() === 's'){ e.preventDefault(); saveSheet(); }
  if(meta && !e.shiftKey && e.key.toLowerCase() === 'e'){ e.preventDefault(); document.getElementById('exportBtn').click(); }
  if(meta && e.shiftKey && e.key.toLowerCase() === 'e'){ e.preventDefault(); exportXlsx(); }
  if(meta && e.key.toLowerCase() === 'n' && !e.shiftKey){ e.preventDefault(); addRow(); }
  if(meta && e.shiftKey && e.key.toLowerCase() === 'n'){ e.preventDefault(); addColumn(); }
  if(meta && e.shiftKey && e.key.toLowerCase() === 'c'){ e.preventDefault(); collapseAll(); }
  if(meta && e.shiftKey && e.key.toLowerCase() === 'o'){ e.preventDefault(); expandAll(); }
});

/* ---------- Button bindings ---------- */
document.getElementById('addRowBtn').addEventListener('click', addRow);
document.getElementById('addColBtn').addEventListener('click', addColumn);
document.getElementById('delColBtn').addEventListener('click', ()=> { if(!confirm('Delete last column?')) return; deleteColumn(sheet.columns.length-1); });
document.getElementById('saveBtn').addEventListener('click', saveSheet);
document.getElementById('collapseAllBtn').addEventListener('click', collapseAll);
document.getElementById('expandAllBtn').addEventListener('click', expandAll);

/* ---------- Init ---------- */
(async function init(){
  if(!sheet.rows || sheet.rows.length === 0){
    const r = [ nowISO(), '', '' ]; r._id = uid(); r._collapsed=false; r._sub=false; sheet.rows=[r];
  }
  updateAuthUI();
  if(token && username) await loadSheet(); else renderTable();
})();
</script>
</body>
</html>