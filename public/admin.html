<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LightTaskSheet — Admin</title>
<style>
  :root{ --bg:#f6fbff; --card:#fff; --muted:#6b7280; --accent:#2563eb; --border:#eef6fb; --radius:10px; }
  body{ margin:14px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial; background:var(--bg); color:#092032; }
  .wrap{ max-width:980px; margin:0 auto; }
  header{ display:flex; gap:12px; align-items:center; padding:12px; background:var(--card); border-radius:10px; border:1px solid var(--border); }
  h2{ margin:0; font-size:1.05rem }
  .spacer{flex:1}
  input{ padding:8px 10px; border-radius:8px; border:1px solid #e9f3fb; }
  button{ padding:8px 10px; border-radius:8px; border:none; cursor:pointer; }
  button.primary{ background:var(--accent); color:white }
  .card{ margin-top:12px; background:var(--card); border-radius:10px; padding:12px; border:1px solid var(--border); }
  table{ width:100%; border-collapse:collapse; font-size:0.95rem; }
  th,td{ padding:8px 10px; border-bottom:1px solid #f3f9fe; text-align:left }
  .small{ font-size:0.92rem; color:var(--muted) }
  .actions button{ margin-right:8px }
  .danger{ background:#ef4444; color:white }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h2>LightTaskSheet — Admin</h2>
      <div class="spacer"></div>
      <input id="username" placeholder="username" />
      <input id="password" placeholder="password" type="password" />
      <button id="loginBtn" class="primary">Login</button>
      <button id="logoutBtn" style="display:none">Logout</button>
    </header>

    <div id="content" style="display:none">
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="flex:1">
            <strong class="small">Create user:</strong><br/>
            <input id="newUser" placeholder="new username" />
            <input id="newPass" placeholder="password" type="password" />
            <label><input id="newIsAdmin" type="checkbox"/> admin</label>
            <button id="createUserBtn" class="primary">Create</button>
          </div>
          <div>
            <button id="refreshUsersBtn">Refresh</button>
            <button id="backupBtn">Run backup now</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <h3 style="margin-top:0">Users</h3>
        <table id="usersTable">
          <thead><tr><th>Username</th><th>Admin</th><th>Created</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="logCard" class="card" style="display:none; margin-top:10px">
        <h3 style="margin-top:0">Backup result</h3>
        <pre id="backupOutput" style="white-space:pre-wrap"></pre>
      </div>
    </div>
  </div>

<script>
const API = '/api';
let token = null; let user = null;

const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const content = document.getElementById('content');

loginBtn.addEventListener('click', async ()=>{
  const u = usernameInput.value.trim(); const p = passwordInput.value;
  if (!u||!p) return alert('username & password');
  const r = await fetch(API + '/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u,password:p})});
  const j = await r.json();
  if (!r.ok) return alert('Login failed: ' + (j.error||r.statusText));
  token = j.token; user = j.username;
  localStorage.setItem('lts_admin_token', token); localStorage.setItem('lts_admin_user', user);
  showAdminUI();
  await refreshUsers();
});
logoutBtn.addEventListener('click', ()=> { token=null; user=null; localStorage.removeItem('lts_admin_token'); localStorage.removeItem('lts_admin_user'); hideAdminUI(); });

function showAdminUI(){ content.style.display='block'; loginBtn.style.display='none'; logoutBtn.style.display='inline-block'; usernameInput.style.display='none'; passwordInput.style.display='none'; }
function hideAdminUI(){ content.style.display='none'; loginBtn.style.display='inline-block'; logoutBtn.style.display='none'; usernameInput.style.display='inline-block'; passwordInput.style.display='inline-block'; }

async function authFetch(path, opts={}) {
  opts.headers = opts.headers || {};
  opts.headers['Content-Type'] = 'application/json';
  if (token) opts.headers['Authorization'] = 'Bearer ' + token;
  const r = await fetch(API + path, opts);
  if (r.status === 401 || r.status === 403) { alert('Auth error — login again'); hideAdminUI(); throw new Error('auth'); }
  return r;
}

document.getElementById('createUserBtn').addEventListener('click', async ()=>{
  const u = document.getElementById('newUser').value.trim();
  const p = document.getElementById('newPass').value;
  const isAdmin = document.getElementById('newIsAdmin').checked;
  if (!u||!p) return alert('username & password');
  const r = await authFetch('/admin/users', { method:'POST', body: JSON.stringify({ username: u, password: p, isAdmin }) });
  const j = await r.json();
  if (!r.ok) return alert('Create user failed: ' + (j.error||r.statusText));
  alert('User created');
  await refreshUsers();
});

document.getElementById('refreshUsersBtn').addEventListener('click', refreshUsers);

async function refreshUsers(){
  try {
    const r = await authFetch('/admin/users');
    const j = await r.json();
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML = '';
    for (const [uname, info] of Object.entries(j.users || {})){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${uname}</td>
        <td>${info.isAdmin ? 'yes' : 'no'}</td>
        <td>${info.createdAt||''}</td>
        <td class="actions"></td>
      `;
      const actions = tr.querySelector('.actions');
      const delBtn = document.createElement('button'); delBtn.textContent='Delete'; delBtn.className='danger';
      delBtn.addEventListener('click', async ()=> {
        if (!confirm('Delete user '+uname+' ?')) return;
        const r = await authFetch('/admin/users/'+encodeURIComponent(uname), { method:'DELETE' });
        const j = await r.json();
        if (!r.ok) return alert('Delete failed: ' + (j.error||r.statusText));
        refreshUsers();
      });
      const toggleBtn = document.createElement('button'); toggleBtn.textContent = info.isAdmin ? 'Revoke admin' : 'Make admin';
      toggleBtn.addEventListener('click', async ()=> {
        const r = await authFetch('/admin/users/'+encodeURIComponent(uname)+'/set-admin', { method:'POST', body: JSON.stringify({ isAdmin: !info.isAdmin })});
        const j = await r.json();
        if (!r.ok) return alert('Failed: ' + (j.error||r.statusText));
        refreshUsers();
      });
      actions.appendChild(toggleBtn);
      actions.appendChild(delBtn);
      tbody.appendChild(tr);
    }
  } catch(e){ console.error(e); }
}

// Backup
document.getElementById('backupBtn').addEventListener('click', async ()=>{
  if (!confirm('Run backup now?')) return;
  const r = await authFetch('/admin/backup', { method:'POST' });
  const j = await r.json();
  if (!r.ok) return alert('Backup failed: ' + (j.error||r.statusText));
  document.getElementById('logCard').style.display = 'block';
  document.getElementById('backupOutput').textContent = j.output || 'ok';
});

// load token if present
(function(){
  const t = localStorage.getItem('lts_admin_token');
  const u = localStorage.getItem('lts_admin_user');
  if (t && u) { token = t; user = u; showAdminUI(); refreshUsers().catch(()=>{ hideAdminUI(); }); }
})();
</script>
</body>
</html>
